// ─────────────────────────────────────────────────────────────────────────────
// Prisma Schema - Sistema de Restaurantes
// ─────────────────────────────────────────────────────────────────────────────

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────────────────────────────────────
// ENUMS
// ─────────────────────────────────────────────────────────────────────────────

enum UserRole {
  customer
  employee
  manager
  admin
}

enum OrderStatus {
  pending
  confirmed
  preparing
  ready
  on_the_way
  delivered
  completed
  cancelled
}

enum OrderType {
  dine_in
  takeout
  delivery
}

enum PaymentStatus {
  pending
  paid
  refunded
  failed
}

enum ReservationStatus {
  pending
  confirmed
  seated
  completed
  cancelled
  no_show
}

// ─────────────────────────────────────────────────────────────────────────────
// MODELS
// ─────────────────────────────────────────────────────────────────────────────

/// Usuarios del sistema (clientes, empleados, managers, admins)
model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique @db.VarChar(255)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  firstName     String    @map("first_name") @db.VarChar(100)
  lastName      String    @map("last_name") @db.VarChar(100)
  phone         String?   @db.VarChar(20)
  role          UserRole  @default(customer)
  avatarUrl     String?   @map("avatar_url") @db.VarChar(500)
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relaciones
  restaurants  Restaurant[]
  addresses    Address[]
  orders       Order[]
  reservations Reservation[]
  reviews      Review[]

  @@index([email])
  @@index([role])
  @@map("users")
}

/// Restaurantes registrados en el sistema
model Restaurant {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @db.VarChar(200)
  slug          String   @unique @db.VarChar(200)
  description   String?  @db.Text
  phone         String   @db.VarChar(20)
  email         String?  @db.VarChar(255)
  logoUrl       String?  @map("logo_url") @db.VarChar(500)
  coverImageUrl String?  @map("cover_image_url") @db.VarChar(500)
  addressLine   String   @map("address_line") @db.VarChar(300)
  city          String   @db.VarChar(100)
  state         String?  @db.VarChar(100)
  postalCode    String?  @map("postal_code") @db.VarChar(20)
  country       String   @default("México") @db.VarChar(100)
  latitude      Decimal? @db.Decimal(10, 8)
  longitude     Decimal? @db.Decimal(11, 8)
  averageRating Decimal  @default(0) @map("average_rating") @db.Decimal(2, 1)
  totalReviews  Int      @default(0) @map("total_reviews")
  isActive      Boolean  @default(true) @map("is_active")
  ownerId       String   @map("owner_id") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relaciones
  owner        User          @relation(fields: [ownerId], references: [id], onDelete: Restrict)
  schedules    Schedule[]
  categories   Category[]
  products     Product[]
  tables       Table[]
  orders       Order[]
  reservations Reservation[]
  reviews      Review[]

  @@index([slug])
  @@index([city])
  @@index([ownerId])
  @@index([isActive])
  @@map("restaurants")
}

/// Horarios de operación del restaurante
model Schedule {
  id           String  @id @default(uuid()) @db.Uuid
  restaurantId String  @map("restaurant_id") @db.Uuid
  dayOfWeek    Int     @map("day_of_week") @db.SmallInt // 0 = Domingo, 6 = Sábado
  openTime     String  @map("open_time") @db.VarChar(5) // HH:mm
  closeTime    String  @map("close_time") @db.VarChar(5) // HH:mm
  isClosed     Boolean @default(false) @map("is_closed")

  // Relaciones
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, dayOfWeek])
  @@index([restaurantId])
  @@map("schedules")
}

/// Categorías del menú
model Category {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  name         String   @db.VarChar(100)
  slug         String   @db.VarChar(100)
  description  String?  @db.Text
  imageUrl     String?  @map("image_url") @db.VarChar(500)
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relaciones
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  products   Product[]

  @@unique([restaurantId, slug])
  @@index([restaurantId])
  @@index([isActive])
  @@map("categories")
}

/// Productos/platos del menú
model Product {
  id              String   @id @default(uuid()) @db.Uuid
  restaurantId    String   @map("restaurant_id") @db.Uuid
  categoryId      String   @map("category_id") @db.Uuid
  name            String   @db.VarChar(200)
  slug            String   @db.VarChar(200)
  description     String?  @db.Text
  price           Decimal  @db.Decimal(10, 2)
  discountPrice   Decimal? @map("discount_price") @db.Decimal(10, 2)
  imageUrl        String?  @map("image_url") @db.VarChar(500)
  preparationTime Int?     @map("preparation_time") // minutos
  calories        Int?
  isVegetarian    Boolean  @default(false) @map("is_vegetarian")
  isVegan         Boolean  @default(false) @map("is_vegan")
  isGlutenFree    Boolean  @default(false) @map("is_gluten_free")
  isFeatured      Boolean  @default(false) @map("is_featured")
  isAvailable     Boolean  @default(true) @map("is_available")
  displayOrder    Int      @default(0) @map("display_order")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relaciones
  restaurant Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category   Category    @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  orderItems OrderItem[]

  @@unique([restaurantId, slug])
  @@index([restaurantId])
  @@index([categoryId])
  @@index([isAvailable])
  @@index([isFeatured])
  @@map("products")
}

/// Mesas del restaurante
model Table {
  id           String   @id @default(uuid()) @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  tableNumber  String   @map("table_number") @db.VarChar(20)
  capacity     Int      @db.SmallInt
  location     String?  @db.VarChar(50) // interior, terraza, privado
  isAvailable  Boolean  @default(true) @map("is_available")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relaciones
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orders       Order[]
  reservations Reservation[]

  @@unique([restaurantId, tableNumber])
  @@index([restaurantId])
  @@index([isAvailable])
  @@map("tables")
}

/// Direcciones de entrega de usuarios
model Address {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  label       String   @default("Casa") @db.VarChar(50)
  addressLine String   @map("address_line") @db.VarChar(300)
  city        String   @db.VarChar(100)
  state       String?  @db.VarChar(100)
  postalCode  String?  @map("postal_code") @db.VarChar(20)
  country     String   @default("México") @db.VarChar(100)
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  instructions String? @db.Text
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relaciones
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
  @@map("addresses")
}

/// Pedidos realizados
model Order {
  id                 String        @id @default(uuid()) @db.Uuid
  orderNumber        String        @unique @map("order_number") @db.VarChar(20)
  restaurantId       String        @map("restaurant_id") @db.Uuid
  customerId         String        @map("customer_id") @db.Uuid
  addressId          String?       @map("address_id") @db.Uuid
  tableId            String?       @map("table_id") @db.Uuid
  status             OrderStatus   @default(pending)
  orderType          OrderType     @map("order_type")
  subtotal           Decimal       @db.Decimal(10, 2)
  tax                Decimal       @default(0) @db.Decimal(10, 2)
  deliveryFee        Decimal       @default(0) @map("delivery_fee") @db.Decimal(10, 2)
  discount           Decimal       @default(0) @db.Decimal(10, 2)
  total              Decimal       @db.Decimal(10, 2)
  paymentMethod      String?       @map("payment_method") @db.VarChar(30)
  paymentStatus      PaymentStatus @default(pending) @map("payment_status")
  notes              String?       @db.Text
  estimatedTime      Int?          @map("estimated_time") // minutos
  confirmedAt        DateTime?     @map("confirmed_at") @db.Timestamptz
  preparedAt         DateTime?     @map("prepared_at") @db.Timestamptz
  deliveredAt        DateTime?     @map("delivered_at") @db.Timestamptz
  cancelledAt        DateTime?     @map("cancelled_at") @db.Timestamptz
  cancellationReason String?       @map("cancellation_reason") @db.Text
  createdAt          DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  // Relaciones
  restaurant Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Restrict)
  customer   User        @relation(fields: [customerId], references: [id], onDelete: Restrict)
  address    Address?    @relation(fields: [addressId], references: [id], onDelete: SetNull)
  table      Table?      @relation(fields: [tableId], references: [id], onDelete: SetNull)
  items      OrderItem[]
  reviews    Review[]

  @@index([restaurantId])
  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt(sort: Desc)])
  @@map("orders")
}

/// Items/líneas de un pedido
model OrderItem {
  id          String   @id @default(uuid()) @db.Uuid
  orderId     String   @map("order_id") @db.Uuid
  productId   String   @map("product_id") @db.Uuid
  productName String   @map("product_name") @db.VarChar(200) // Snapshot del nombre
  quantity    Int      @db.SmallInt
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2) // Snapshot del precio
  subtotal    Decimal  @db.Decimal(10, 2)
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relaciones
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

/// Reservaciones de mesas
model Reservation {
  id                 String            @id @default(uuid()) @db.Uuid
  reservationNumber  String            @unique @map("reservation_number") @db.VarChar(20)
  restaurantId       String            @map("restaurant_id") @db.Uuid
  customerId         String            @map("customer_id") @db.Uuid
  tableId            String?           @map("table_id") @db.Uuid
  partySize          Int               @map("party_size") @db.SmallInt
  reservationDate    DateTime          @map("reservation_date") @db.Date
  reservationTime    String            @map("reservation_time") @db.VarChar(5) // HH:mm
  durationMinutes    Int               @default(90) @map("duration_minutes")
  status             ReservationStatus @default(pending)
  notes              String?           @db.Text
  confirmedAt        DateTime?         @map("confirmed_at") @db.Timestamptz
  cancelledAt        DateTime?         @map("cancelled_at") @db.Timestamptz
  cancellationReason String?           @map("cancellation_reason") @db.Text
  createdAt          DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  // Relaciones
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Restrict)
  customer   User       @relation(fields: [customerId], references: [id], onDelete: Restrict)
  table      Table?     @relation(fields: [tableId], references: [id], onDelete: SetNull)

  @@index([restaurantId])
  @@index([customerId])
  @@index([reservationDate])
  @@index([status])
  @@map("reservations")
}

/// Reseñas y valoraciones
model Review {
  id           String    @id @default(uuid()) @db.Uuid
  restaurantId String    @map("restaurant_id") @db.Uuid
  customerId   String    @map("customer_id") @db.Uuid
  orderId      String?   @map("order_id") @db.Uuid
  rating       Int       @db.SmallInt // 1-5
  title        String?   @db.VarChar(200)
  comment      String?   @db.Text
  isVerified   Boolean   @default(false) @map("is_verified")
  isVisible    Boolean   @default(true) @map("is_visible")
  response     String?   @db.Text // Respuesta del restaurante
  responseAt   DateTime? @map("response_at") @db.Timestamptz
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relaciones
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  customer   User       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  order      Order?     @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@unique([customerId, restaurantId]) // Un usuario, una reseña por restaurante
  @@index([restaurantId])
  @@index([customerId])
  @@index([rating])
  @@map("reviews")
}
